async function r() {
  const params = new URLSearchParams(window.location.search);
  const connection = params.get('c');
  if (connection) {
    const campaigns = document.querySelectorAll(
      `script[src="http://localhost:3000/cdn/r.min.js"]`,
    );

    if (campaigns.length === 1)
      await fetch(
        `http://localhost:3000/api/connection?connect=${connection}`,
        {
          method: 'POST',
        },
      );
    window.close();
    window.location.search = '';
    return;
  }

  const params_url = params.get('p');
  const campaign_id = document
    .querySelector(`script[src="http://localhost:3000/cdn/r.min.js"]`)
    .getAttribute('data-campaign');
  if (!campaign_id) return;

  window.location.href = `http://localhost:3000/${campaign_id}.${params_url}${window.location.search.replace(
    `p=${params.get('p')}`,
    `origin=${window.location.origin}`,
  )}`;
}

r();
